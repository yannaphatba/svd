# 1. Database Storage (MySQL PVC)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
  namespace: sdv
spec:
  accessModes: [ReadWriteOnce]
  resources: { requests: { storage: 2Gi } }
---
# 2. MySQL Service
apiVersion: v1
kind: Service
metadata:
  name: mysql-service
  namespace: sdv
spec:
  ports: [{ port: 3306 }]
  selector: { app: mysql }
---
# 3. MySQL Deployment (แก้ไขเรื่อง Storage)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
  namespace: sdv
spec:
  selector: { matchLabels: { app: mysql } }
  template:
    metadata: { labels: { app: mysql } }
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        resources:
          requests:
            cpu: "100m"
            memory: "256Mi"
          limits:
            cpu: "200m"
            memory: "512Mi"
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: "mydbpassword"
        - name: MYSQL_DATABASE
          value: "mydb"
        - name: MYSQL_USER
          value: "myuser"
        - name: MYSQL_PASSWORD
          value: "mypassword"
        - name: MYSQL_ROOT_HOST
          value: "%"
        ports: [{ containerPort: 3306 }]
        volumeMounts:
        - name: mysql-storage # ชื่อต้องตรงกับ volumes ด้านล่าง
          mountPath: /var/lib/mysql
      volumes:
      - name: mysql-storage
        persistentVolumeClaim:
          claimName: mysql-pvc # เชื่อมกับ PVC ด้านบนเพื่อให้ข้อมูลคงอยู่
---
# 4. MinIO Service (internal only)
apiVersion: v1
kind: Service
metadata:
  name: minio
  namespace: sdv
spec:
  ports: [{ port: 9000, targetPort: 9000 }]
  selector: { app: minio }
---
# 5. MinIO Deployment (emptyDir, non-persistent)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: minio
  namespace: sdv
spec:
  selector: { matchLabels: { app: minio } }
  template:
    metadata: { labels: { app: minio } }
    spec:
      initContainers:
      - name: init-bucket
        image: alpine:3.19
        resources:
          requests:
            cpu: "10m"
            memory: "32Mi"
          limits:
            cpu: "50m"
            memory: "64Mi"
        command:
        - sh
        - -c
        - |
          mkdir -p /data/sdv-uploads
        volumeMounts:
        - name: minio-data
          mountPath: /data
      containers:
      - name: minio
        image: minio/minio:latest
        resources:
          requests:
            cpu: "100m"
            memory: "256Mi"
          limits:
            cpu: "250m"
            memory: "512Mi"
        args: ["server", "/data", "--address", ":9000", "--console-address", ":9001"]
        env:
        - name: MINIO_ROOT_USER
          value: "sdvadmin"
        - name: MINIO_ROOT_PASSWORD
          value: "sdvadmin12345"
        ports: [{ containerPort: 9000 }]
        volumeMounts:
        - name: minio-data
          mountPath: /data
      volumes:
      - name: minio-data
        emptyDir: {}
---
# 4. PHP-Nginx Service
apiVersion: v1
kind: Service
metadata:
  name: php-service
  namespace: sdv
spec:
  ports: [{ port: 80 }]
  selector: { app: php }
---
# 6. PHP-Nginx Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: php-app
  namespace: sdv
spec:
  progressDeadlineSeconds: 1200
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 0
      maxUnavailable: 1
  selector: { matchLabels: { app: php } }
  template:
    metadata: { labels: { app: php } }
    spec:
      containers:
      - name: php-nginx
        image: ghcr.io/yannaphatba/sdv:placeholder # สำหรับให้ GitHub Actions มา Replace
        imagePullPolicy: Always
        resources:
          requests: { cpu: "100m", memory: "256Mi" }
          limits: { cpu: "300m", memory: "512Mi" }
        ports: [{ containerPort: 80 }]
        env:
        - name: APP_KEY
          value: "base64:u38JIDuY8p7O6I5O+6N4XhV7f5O7rG7i9R7T4u5I6O0="
        - name: APP_URL
          value: "https://project.cpe.rmuti.ac.th/sdv"
        - name: ASSET_URL
          value: "https://project.cpe.rmuti.ac.th/sdv"
        - name: MAIL_MAILER
          value: "smtp"
        - name: MAIL_HOST
          value: "smtp.gmail.com"
        - name: MAIL_PORT
          value: "587"
        - name: MAIL_ENCRYPTION
          value: "tls"
        - name: MAIL_USERNAME
          valueFrom:
            secretKeyRef:
              name: smtp-credentials
              key: SMTP_USERNAME
        - name: MAIL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: smtp-credentials
              key: SMTP_PASSWORD
        - name: MAIL_FROM_ADDRESS
          value: "yannaphat.ba@rmuti.ac.th"
        - name: MAIL_FROM_NAME
          value: "Student Dormitory Vehicle Registration Verification System"
        - name: FILESYSTEM_DISK
          value: "s3"
        - name: AWS_ACCESS_KEY_ID
          value: "sdvadmin"
        - name: AWS_SECRET_ACCESS_KEY
          value: "sdvadmin12345"
        - name: AWS_DEFAULT_REGION
          value: "us-east-1"
        - name: AWS_BUCKET
          value: "sdv-uploads"
        - name: AWS_ENDPOINT
          value: "http://minio:9000"
        - name: AWS_USE_PATH_STYLE_ENDPOINT
          value: "true"
        - name: DB_CONNECTION
          value: "mysql"
        - name: DB_HOST
          value: "mysql-service" # ตรงกับชื่อ Service ของ MySQL
        - name: DB_DATABASE
          value: "mydb"
        - name: DB_USERNAME
          value: "myuser"
        - name: DB_PASSWORD
          value: "mypassword"
        - name: SESSION_DRIVER
          value: "file"
        - name: CACHE_STORE
          value: "file"
---
# 7. Ingress (strip /sdv prefix at Ingress level)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: php-ingress
  namespace: sdv
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
spec:
  ingressClassName: traefik
  rules:
  - host: project.cpe.rmuti.ac.th
    http:
      paths:
      - path: /sdv
        pathType: Prefix
        backend:
          service:
            name: php-service
            port:
              number: 80


